---
layout: post
title: "Linux 中断与异常"
date:   2025-9-1
tags: [Linux, interrupt]
comments: true
author: braisedp
toc : true
---

## 中断与异常

### 中断
异步中断（异常）：由其他硬件设备产生
同步中断（中断）：由CPU控制单元产生

每一个中断或者异常都由一个0~255之间的整数表示，称为中断向量

### 中断分类
1. 可屏蔽中断 （清空IF标志位可以屏蔽可屏蔽中断）
2. 非屏蔽中断

### 异常分类
1. 处理器探测异常
    - 故障
    - 陷阱
    - 异常中止
2. 编程异常

### 中断描述符表（IDT）

中断描述符表为一个系统表，与每一个中断或异常向量相关联，用于描述每个向量对应的异常处理程序的入口

#### 任务门描述符

其中保存中断信号发生时需要取代当前进程的另一个进程的TSS选择符
```mermaid
packet

0-15: "保留"
16-31: "TSS SEGMENT SELECTOR"
32-39: "保留"
+1: "1"
+1: "0"
+1: "1"
+1: "0"
+1: "0"
+2: "DPL"
+1: "P"
+16: "保留"
```

#### 中断门描述符

其中保存中断信号发生时需要转移到的段的选择符以及段内偏移量，当控制权转移到合适的段时，清除IF标志，关闭会发生的可屏蔽中断

```mermaid
packet
+16: "偏移量（0-15）"
+16: "段选择符"
+5: "保留"
+1: "0"
+1: "0"
+1: "0"
+1: "0"
+1: "1"
+1: "1"
+1: "1"
+1: "0"
+2: "DPL"
+1: "P"
+16: "偏移量（16-31）"
```

#### 陷阱门描述符

转移到段后不会清空IF标志
```mermaid
packet
+16: "偏移量（0-15）"
+16: "段选择符"
+5 : "保留"
+1: "0"
+1: "0"
+1: "0"
+1: "1"
+1: "1"
+1: "1"
+1: "1"
+1: "0"
+2: "DPL"
+1: "P"
+16: "偏移量（16-31）"
```

### 中断和异常的处理逻辑

```mermaid
flowchart
start[确定中断向量]-->step1[通过idtr寄存器值找到IDT表中的对应项]-->step2[通过gdtr寄存器值找到GDT的基地址]-->step3[在GDT中查找段描述符]-->step4[将cs的低两位（CPL）与段描述符的DPL进行对比]-->step5{CPL < DPL}--是-->step6[产生 General Protection异常]
step5--否-->step7{是否是编程异常}--是-->step8[与门描述符中的DPL进行对比]-->step9{CPL  < DPL}--是-->step6 
subgraph 处理特权级的变化
step11{CPL ≠ 段描述符的DPL}--是-->step12[从tr寄存器中读取运行进程的TSS段]-->step13[通过新特权级装载ss和esp寄存器]-->step14[在新的栈中保存ss和esp以前的值]
end
step7--否-->step11
step9--否-->step11
step14-->step15{故障已经发生}--是-->step16[用引起异常的指令地址装载ss和esp]-->step17[在栈中保存eflags，cs和eip]-->step18[如果产生硬件出错码则保存]-->step19[装在cs和eip寄存器]
step11--否-->step15
step15--否-->step17
```